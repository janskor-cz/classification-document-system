/**

- Classification Document System - Main JavaScript
- Handles common functionality across the application
  */

// ============================================================================
// GLOBAL CONFIGURATION
// ============================================================================

const App = {
config: {
apiBase: â€˜/apiâ€™,
refreshInterval: 30000, // 30 seconds
toastDuration: 5000,    // 5 seconds
maxRetries: 3,
retryDelay: 1000
},

```
state: {
    isOnline: true,
    identusStatus: null,
    currentUser: null,
    notifications: []
}
```

};

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener(â€˜DOMContentLoadedâ€™, function() {
console.log(â€˜ðŸš€ Classification Document System - Initializingâ€¦â€™);

```
// Initialize core functionality
initializeApp();
initializeToastContainer();
initializeStatusMonitoring();
initializeEventListeners();

console.log('âœ… Application initialized successfully');
```

});

function initializeApp() {
// Check if user is authenticated
checkAuthentication();

```
// Load initial system status
updateSystemStatus();

// Setup periodic updates
setInterval(updateSystemStatus, App.config.refreshInterval);

// Setup online/offline detection
window.addEventListener('online', handleOnline);
window.addEventListener('offline', handleOffline);
```

}

// ============================================================================
// AUTHENTICATION
// ============================================================================

async function checkAuthentication() {
try {
const response = await apiCall(â€™/auth/statusâ€™);
if (response.authenticated) {
App.state.currentUser = response.user;
updateUserInterface();
}
} catch (error) {
console.log(â€˜User not authenticatedâ€™);
}
}

function updateUserInterface() {
const user = App.state.currentUser;
if (!user) return;

```
// Update user-specific UI elements
const userElements = document.querySelectorAll('[data-user-name]');
userElements.forEach(el => {
    el.textContent = user.name || 'Unknown User';
});

const credentialElements = document.querySelectorAll('[data-user-credentials]');
credentialElements.forEach(el => {
    el.textContent = user.credentials_count || 0;
});
```

}

// ============================================================================
// SYSTEM STATUS MONITORING
// ============================================================================

function initializeStatusMonitoring() {
// Initial status check
updateSystemStatus();

```
// Periodic status updates
setInterval(updateSystemStatus, App.config.refreshInterval);
```

}

async function updateSystemStatus() {
try {
const response = await apiCall(â€™/system/statusâ€™);
App.state.identusStatus = response;

```
    updateStatusIndicators(response);
    updateSystemHealth(response);
    
} catch (error) {
    console.error('Failed to update system status:', error);
    showOfflineStatus();
}
```

}

function updateStatusIndicators(status) {
const systemStatus = document.getElementById(â€˜system-statusâ€™);
const identusStatus = document.getElementById(â€˜identus-statusâ€™);

```
if (systemStatus) {
    if (status.system_healthy) {
        systemStatus.className = 'badge bg-success me-2';
        systemStatus.innerHTML = '<i class="fas fa-check-circle me-1"></i>System Online';
    } else {
        systemStatus.className = 'badge bg-danger me-2';
        systemStatus.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>System Issues';
    }
}

if (identusStatus) {
    if (status.identus_healthy) {
        identusStatus.className = 'badge bg-info me-2';
        identusStatus.innerHTML = '<i class="fas fa-cloud me-1"></i>Identus Ready';
    } else {
        identusStatus.className = 'badge bg-warning me-2';
        identusStatus.innerHTML = '<i class="fas fa-cloud-exclamation me-1"></i>Identus Issues';
    }
}
```

}

function updateSystemHealth(status) {
const services = [â€˜identus-issuerâ€™, â€˜identus-holderâ€™, â€˜identus-verifierâ€™, â€˜databaseâ€™];

```
services.forEach(service => {
    const element = document.getElementById(`${service}-status`);
    if (element) {
        const isHealthy = status[service.replace('-', '_')] || false;
        updateServiceIndicator(element, isHealthy);
    }
});
```

}

function updateServiceIndicator(element, isHealthy) {
if (isHealthy) {
element.className = â€˜h2 text-success mb-1â€™;
element.innerHTML = â€˜<i class="fas fa-check-circle"></i>â€™;
} else {
element.className = â€˜h2 text-danger mb-1â€™;
element.innerHTML = â€˜<i class="fas fa-exclamation-circle"></i>â€™;
}
}

function showOfflineStatus() {
const systemStatus = document.getElementById(â€˜system-statusâ€™);
const identusStatus = document.getElementById(â€˜identus-statusâ€™);

```
if (systemStatus) {
    systemStatus.className = 'badge bg-secondary me-2';
    systemStatus.innerHTML = '<i class="fas fa-wifi me-1"></i>Offline';
}

if (identusStatus) {
    identusStatus.className = 'badge bg-secondary me-2';
    identusStatus.innerHTML = '<i class="fas fa-cloud-off me-1"></i>Offline';
}
```

}

// ============================================================================
// API UTILITIES
// ============================================================================

async function apiCall(endpoint, options = {}) {
const url = `${App.config.apiBase}${endpoint}`;
const defaultOptions = {
headers: {
â€˜Content-Typeâ€™: â€˜application/jsonâ€™,
},
credentials: â€˜includeâ€™
};

```
const config = { ...defaultOptions, ...options };

try {
    const response = await fetch(url, config);
    
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
        return await response.json();
    } else {
        return await response.text();
    }
    
} catch (error) {
    console.error(`API call failed: ${endpoint}`, error);
    throw error;
}
```

}

async function apiCallWithRetry(endpoint, options = {}, retries = App.config.maxRetries) {
for (let i = 0; i < retries; i++) {
try {
return await apiCall(endpoint, options);
} catch (error) {
if (i === retries - 1) throw error;
await delay(App.config.retryDelay * (i + 1));
}
}
}

function delay(ms) {
return new Promise(resolve => setTimeout(resolve, ms));
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

function initializeToastContainer() {
let container = document.getElementById(â€˜toast-containerâ€™);
if (!container) {
container = document.createElement(â€˜divâ€™);
container.id = â€˜toast-containerâ€™;
container.className = â€˜toast-container position-fixed bottom-0 end-0 p-3â€™;
container.style.zIndex = â€˜1055â€™;
document.body.appendChild(container);
}
}

function showToast(message, type = â€˜infoâ€™, duration = App.config.toastDuration) {
const toastContainer = document.getElementById(â€˜toast-containerâ€™);
if (!toastContainer) {
initializeToastContainer();
return showToast(message, type, duration);
}

```
const toastId = 'toast-' + Date.now();
const toast = document.createElement('div');
toast.id = toastId;
toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
toast.setAttribute('role', 'alert');
toast.setAttribute('aria-live', 'assertive');
toast.setAttribute('aria-atomic', 'true');

toast.innerHTML = `
    <div class="d-flex">
        <div class="toast-body">
            ${getToastIcon(type)} ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
`;

toastContainer.appendChild(toast);

const bsToast = new bootstrap.Toast(toast, {
    autohide: true,
    delay: duration
});

bsToast.show();

// Remove after hiding
toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
});

return toastId;
```

}

function getToastIcon(type) {
const icons = {
success: â€˜<i class="fas fa-check-circle me-2"></i>â€™,
error: â€˜<i class="fas fa-exclamation-circle me-2"></i>â€™,
warning: â€˜<i class="fas fa-exclamation-triangle me-2"></i>â€™,
info: â€˜<i class="fas fa-info-circle me-2"></i>â€™
};
return icons[type] || icons.info;
}

function showSuccess(message) {
showToast(message, â€˜successâ€™);
}

function showError(message) {
showToast(message, â€˜errorâ€™);
}

function showWarning(message) {
showToast(message, â€˜warningâ€™);
}

function showInfo(message) {
showToast(message, â€˜infoâ€™);
}

// ============================================================================
// FORM UTILITIES
// ============================================================================

function initializeEventListeners() {
// Form validation
document.querySelectorAll(â€˜form[data-validate]â€™).forEach(form => {
form.addEventListener(â€˜submitâ€™, handleFormSubmit);
});

```
// Classification selectors
document.querySelectorAll('.classification-selector').forEach(selector => {
    selector.addEventListener('click', handleClassificationSelect);
});

// File inputs
document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', handleFileSelect);
});

// Auto-save forms
document.querySelectorAll('form[data-autosave]').forEach(form => {
    setupAutoSave(form);
});
```

}

function handleFormSubmit(event) {
const form = event.target;
const submitBtn = form.querySelector(â€˜button[type=â€œsubmitâ€]â€™);

```
if (!validateForm(form)) {
    event.preventDefault();
    return false;
}

// Show loading state
if (submitBtn) {
    setButtonLoading(submitBtn, true);
}
```

}

function validateForm(form) {
let isValid = true;
const errors = [];

```
// Check required fields
const requiredFields = form.querySelectorAll('[required]');
requiredFields.forEach(field => {
    if (!field.value.trim()) {
        isValid = false;
        errors.push(`${getFieldLabel(field)} is required`);
        markFieldError(field);
    } else {
        clearFieldError(field);
    }
});

// Check file size limits
const fileInputs = form.querySelectorAll('input[type="file"]');
fileInputs.forEach(input => {
    if (input.files.length > 0) {
        const file = input.files[0];
        const maxSize = parseInt(input.dataset.maxSize) || (100 * 1024 * 1024);
        if (file.size > maxSize) {
            isValid = false;
            errors.push(`File size must be less than ${formatFileSize(maxSize)}`);
            markFieldError(input);
        }
    }
});
```
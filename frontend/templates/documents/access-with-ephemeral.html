{% extends "base.html" %}

{% block title %}Secure Document Access - Ephemeral DID{% endblock %}

{% block head %}
<style>
    .ephemeral-access-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .security-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .security-badge .shield-icon {
        font-size: 24px;
        margin-right: 8px;
    }
    
    .progress-container {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
    }
    
    .progress-step {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .progress-step:last-child {
        border-bottom: none;
    }
    
    .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 14px;
        font-weight: bold;
    }
    
    .step-icon.pending {
        background-color: #6c757d;
        color: white;
    }
    
    .step-icon.active {
        background-color: #007bff;
        color: white;
        animation: pulse 2s infinite;
    }
    
    .step-icon.completed {
        background-color: #28a745;
        color: white;
    }
    
    .step-icon.error {
        background-color: #dc3545;
        color: white;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .security-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .security-warning .warning-icon {
        color: #856404;
        margin-right: 8px;
    }
    
    .session-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: none;
    }
    
    .countdown-timer {
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
    }
    
    .countdown-timer.warning {
        color: #ffc107;
    }
    
    .countdown-timer.critical {
        color: #dc3545;
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        50% { opacity: 0.5; }
    }
    
    .document-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .classification-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .classification-public {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .classification-internal {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .classification-confidential {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .key-management-info {
        background-color: #e7f3ff;
        border: 1px solid #b8daff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .download-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
    }
    
    .cleanup-confirmation {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        display: none;
    }
    
    .error-container {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: none;
    }
    
    .btn-secure-access {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-secure-access:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        color: white;
    }
    
    .btn-secure-access:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Load Identus Client and new Ephemeral DID Client -->
<script src="{{ url_for('static', filename='js/identus-client.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/ephemeral-did.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script>
console.log('üîß JAVASCRIPT FILES LOADING...');
console.log('üîß Loading identus-client.js and ephemeral-did.js');
</script>
{% endblock %}

{% block content %}
<script>
console.log('üöÄ PAGE SCRIPT EXECUTING - BASIC TEST');
console.log('üîç Date.now():', Date.now());
console.log('üîç User agent:', navigator.userAgent);
alert('üß™ JavaScript Test - If you see this alert, JavaScript is working!');
</script>

<div class="ephemeral-access-container">
    <div class="security-badge">
        <span class="shield-icon">üîê</span>
        <strong>Secure Document Access</strong> - Client-Side Ephemeral DID Encryption
    </div>
    
    <!-- Document Information -->
    <div class="document-info">
        <h4>üìÑ Document Information</h4>
        <div class="row">
            <div class="col-md-8">
                <p><strong>Document ID:</strong> <span id="document-id">{{ document.id if document else 'N/A' }}</span></p>
                <p><strong>Filename:</strong> <span id="document-filename">{{ document.filename if document else 'N/A' }}</span></p>
                <p><strong>Classification Level:</strong> 
                    <span id="classification-badge" class="classification-badge">
                        {{ document.classification_level_name if document else 'N/A' }}
                    </span>
                </p>
                <p><strong>Size:</strong> <span id="document-size">{{ document.size if document else 'N/A' }}</span></p>
            </div>
            <div class="col-md-4">
                <p><strong>Upload Date:</strong> {{ document.created_at.strftime('%Y-%m-%d %H:%M') if document else 'N/A' }}</p>
                <p><strong>Uploaded By:</strong> {{ document.created_by_name if document else 'N/A' }}</p>
            </div>
        </div>
    </div>
    
    <!-- Security Warning -->
    <div class="security-warning">
        <span class="warning-icon">‚ö†Ô∏è</span>
        <strong>Security Notice:</strong> This document will be accessed using ephemeral DID-based encryption. 
        Your private key will be generated in your browser and never transmitted to our servers, ensuring maximum security.
        The access session will expire automatically, and your ephemeral key will be permanently destroyed.
    </div>
    
    <!-- Key Management Information -->
    <div class="key-management-info">
        <h5>üîë Ephemeral Key Management</h5>
        <ul class="mb-0">
            <li><strong>Client-Side Generation:</strong> Your ephemeral DID and private key are generated entirely in your browser</li>
            <li><strong>Perfect Forward Secrecy:</strong> Each document access uses a unique, temporary key pair</li>
            <li><strong>Zero Server Exposure:</strong> Your private key never leaves your device</li>
            <li><strong>Automatic Cleanup:</strong> Keys are automatically destroyed after use or session expiration</li>
        </ul>
    </div>
    
    <!-- Error Container -->
    <div id="error-container" class="error-container">
        <h5>‚ùå Error</h5>
        <p id="error-message"></p>
        <button type="button" class="btn btn-outline-danger" onclick="retryOperation()">
            üîÑ Retry
        </button>
    </div>
    
    <!-- Progress Container -->
    <div id="progress-container" class="progress-container">
        <h5>üîÑ Secure Access Progress</h5>
        
        <div class="progress-step" id="step-1">
            <div class="step-icon pending">1</div>
            <div class="step-content">
                <strong>Generate Ephemeral DID</strong>
                <div class="step-details">Creating unique client-side DID:key pair...</div>
            </div>
        </div>
        
        <div class="progress-step" id="step-2">
            <div class="step-icon pending">2</div>
            <div class="step-content">
                <strong>Verify Classification Credentials</strong>
                <div class="step-details">Validating your access permissions...</div>
            </div>
        </div>
        
        <div class="progress-step" id="step-3">
            <div class="step-icon pending">3</div>
            <div class="step-content">
                <strong>Create Access Session</strong>
                <div class="step-details">Establishing secure ephemeral session...</div>
            </div>
        </div>
        
        <div class="progress-step" id="step-4">
            <div class="step-icon pending">4</div>
            <div class="step-content">
                <strong>Encrypt Document</strong>
                <div class="step-details">Encrypting document with your ephemeral public key...</div>
            </div>
        </div>
        
        <div class="progress-step" id="step-5">
            <div class="step-icon pending">5</div>
            <div class="step-content">
                <strong>Client-Side Decryption</strong>
                <div class="step-details">Decrypting document in your browser...</div>
            </div>
        </div>
    </div>
    
    <!-- Session Information -->
    <div id="session-info" class="session-info">
        <h5>üìä Active Ephemeral Session</h5>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Session Token:</strong> <span id="session-token">N/A</span></p>
                <p><strong>Ephemeral DID:</strong> <code id="ephemeral-did">N/A</code></p>
            </div>
            <div class="col-md-6">
                <p><strong>Session Expires:</strong> <span id="session-expiry">N/A</span></p>
                <p><strong>Time Remaining:</strong> <span id="countdown-timer" class="countdown-timer">N/A</span></p>
            </div>
        </div>
    </div>
    
    <!-- Download Section -->
    <div id="download-section" class="download-section">
        <h5>üì• Document Download</h5>
        <p>Your document has been successfully decrypted and is ready for download.</p>
        <div class="d-flex gap-3 align-items-center">
            <button type="button" class="btn btn-success" onclick="downloadDocument()">
                üìÑ Download Document
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="viewDocument()">
                üëÅÔ∏è View in Browser
            </button>
        </div>
    </div>
    
    <!-- Access Request Form -->
    <div id="access-request-form">
        <h5>üöÄ Request Secure Document Access</h5>
        <form onsubmit="requestEphemeralAccess(event)">
            <div class="mb-3">
                <label for="business-justification" class="form-label">Business Justification</label>
                <textarea class="form-control" id="business-justification" rows="3" 
                          placeholder="Please explain why you need to access this document..." required></textarea>
                <div class="form-text">This justification will be logged for audit purposes.</div>
            </div>
            
            <div class="mb-3">
                <label for="session-duration" class="form-label">Session Duration</label>
                <select class="form-select" id="session-duration">
                    <option value="60">1 hour (recommended)</option>
                    <option value="30">30 minutes</option>
                    <option value="15">15 minutes</option>
                </select>
                <div class="form-text">How long you need access to this document. Shorter durations are more secure.</div>
            </div>
            
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="security-acknowledgment" required>
                    <label class="form-check-label" for="security-acknowledgment">
                        I understand that my ephemeral private key will be generated client-side and will be automatically destroyed after the session expires.
                    </label>
                </div>
            </div>
            
            <div class="d-flex gap-3">
                <button type="submit" class="btn-secure-access" id="request-access-btn">
                    üîê Generate Ephemeral DID & Request Access
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </form>
    </div>
    
    <!-- Cleanup Confirmation -->
    <div id="cleanup-confirmation" class="cleanup-confirmation">
        <h5>‚úÖ Session Cleanup Complete</h5>
        <p>Your ephemeral key has been securely destroyed and the session has been terminated.</p>
        <div class="d-flex gap-3">
            <button type="button" class="btn btn-primary" onclick="startNewSession()">
                üîÑ Start New Session
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                ‚Üê Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script>
// Global variables for session management
let currentSession = null;
let countdownInterval = null;
let documentData = {
    id: {{ document.id if document else 'null' }},
    filename: '{{ document.filename if document else '' }}',
    classificationLevel: {{ document.classification_level if document else 'null' }}
};

// Wait for new ephemeral DID client to be ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM LOADED - DEBUGGING ACTIVE');
    console.log('üîç Current URL:', window.location.href);
    console.log('üîç Document title:', document.title);
    
    // Wait a moment for the ephemeral client to initialize
    setTimeout(() => {
        console.log('üîç Checking ephemeral client after 1 second...');
        console.log('üîç window.ephemeralDIDClient exists?', !!window.ephemeralDIDClient);
        console.log('üîç window.ephemeralDIDManager exists?', !!window.ephemeralDIDManager);
        
        if (window.ephemeralDIDClient) {
            console.log('‚úÖ New Ephemeral DID Client is ready');
        } else {
            console.error('‚ùå Ephemeral DID Client not available');
            showError('Failed to initialize new cryptographic system');
        }
    }, 1000);
});

/**
 * Request ephemeral document access
 */
async function requestEphemeralAccess(event) {
    event.preventDefault();
    
    if (!window.ephemeralDIDClient) {
        showError('New Ephemeral DID Client not initialized. Please refresh the page.');
        return;
    }
    
    try {
        // Show progress
        showProgress();
        setStepActive(1);
        
        // Get form data with error checking
        const businessJustificationElement = document.getElementById('business-justification');
        const sessionDurationElement = document.getElementById('session-duration');
        
        if (!businessJustificationElement) {
            throw new Error('Business justification form field not found');
        }
        
        const businessJustification = businessJustificationElement.value;
        const sessionDuration = sessionDurationElement ? parseInt(sessionDurationElement.value) : 60;
        
        // Step 1: Generate ephemeral DID using new client
        updateStepDetails(1, 'Generating unique DID:key pair in your browser...');
        const didResult = await window.ephemeralDIDClient.generateEphemeralDIDForDocument(
            documentData.id, 
            businessJustification, 
            sessionDuration
        );
        
        if (!didResult.success) {
            throw new Error(didResult.error || 'Failed to generate ephemeral DID');
        }
        
        // Debug: Check what we got from DID generation
        console.log('üì• DID generation result:', {
            success: didResult.success,
            hasEphemeralDID: !!didResult.ephemeralDID,
            hasEphemeralPublicKey: !!didResult.ephemeralPublicKey,
            hasDocumentId: !!didResult.documentId,
            documentId: didResult.documentId,
            ephemeralDID: didResult.ephemeralDID,
            keys: Object.keys(didResult)
        });
        console.log('üì• Full didResult:', didResult);
        
        setStepCompleted(1);
        console.log('‚úÖ Ephemeral DID generated:', didResult.ephemeralDID);
        
        // Step 2: Request document access with ephemeral DID
        setStepActive(2);
        updateStepDetails(2, 'Requesting secure document access...');
        
        const accessResult = await window.ephemeralDIDClient.requestDocumentWithEphemeralDID(didResult);
        
        if (!accessResult.success) {
            throw new Error(accessResult.error || 'Failed to request document access');
        }
        
        setStepCompleted(2);
        
        // Step 3: Session established
        setStepActive(3);
        updateStepDetails(3, 'Secure ephemeral session established...');
        
        // Store session information
        currentSession = {
            sessionToken: accessResult.sessionToken,
            ephemeralDID: accessResult.ephemeralDID,
            sessionId: accessResult.sessionId,
            expiresAt: new Date(accessResult.expiresAt)
        };
        
        // Debug: Check session expiry
        console.log('üïí Session timing debug:', {
            expiresAtRaw: accessResult.expiresAt,
            expiresAtParsed: currentSession.expiresAt,
            isValidDate: !isNaN(currentSession.expiresAt.getTime()),
            currentTime: new Date(),
            timeUntilExpiry: currentSession.expiresAt - new Date(),
            willExpireImmediately: (currentSession.expiresAt - new Date()) <= 0
        });
        
        setStepCompleted(3);
        
        // Step 4: Download and decrypt document
        setStepActive(4);
        updateStepDetails(4, 'Downloading and decrypting document...');
        
        // Initiating document decryption process
        
        alert('üîì ABOUT TO CALL decryptDocumentWithEphemeralKey with token: ' + accessResult.sessionToken);
        
        const decryptResult = await window.ephemeralDIDClient.decryptDocumentWithEphemeralKey(accessResult.sessionToken);
        
        alert('üîç DECRYPT RESULT: Success=' + decryptResult.success + ', HasDecryptedData=' + !!decryptResult.decryptedData + ', HasDocumentData=' + !!decryptResult.documentData + ', DecryptedDataType=' + typeof decryptResult.decryptedData + ', DocumentDataType=' + typeof decryptResult.documentData);
        
        // Check both possible property names
        const actualData = decryptResult.decryptedData || decryptResult.documentData;
        alert('üîç ACTUAL DATA: Length=' + (actualData ? actualData.length : 0) + ', Type=' + typeof actualData);
        
        if (actualData && typeof actualData === 'string') {
            alert('üîç DECRYPTED STRING: Preview=' + actualData.substring(0, 50) + ', IsPDF=' + actualData.startsWith('%PDF'));
        } else if (actualData instanceof Uint8Array) {
            alert('üîç DECRYPTED UINT8ARRAY: Length=' + actualData.length + ', First4Bytes=' + Array.from(actualData.slice(0, 4)));
        }
        
        if (!decryptResult.success) {
            console.error('‚ùå Decryption failed:', decryptResult.error);
            throw new Error(decryptResult.error || 'Failed to decrypt document');
        }
        
        setStepCompleted(4);
        
        // Step 5: Document ready
        setStepActive(5);
        updateStepDetails(5, 'Document ready for secure access!');
        setStepCompleted(5);
        
        // Debug: Check what decryptResult contains
        console.log('üîç decryptResult structure:', {
            hasSuccess: !!decryptResult.success,
            hasDocumentData: !!decryptResult.documentData,
            hasDecryptedData: !!decryptResult.decryptedData,
            keys: Object.keys(decryptResult),
            content: decryptResult
        });
        
        // Create properly structured data for download - fix property name mismatch
        const actualDecryptedData = decryptResult.decryptedData || decryptResult.documentData;
        const downloadData = {
            documentData: actualDecryptedData,
            filename: decryptResult.filename || documentData.filename,
            contentType: decryptResult.contentType || 'application/pdf', // Default to PDF for documents
            classificationLevel: decryptResult.classificationLevel,
            sessionToken: decryptResult.sessionToken,
            message: decryptResult.message
        };
        
        console.log('üìÑ CRITICAL DEBUG - Download data prepared:', {
            hasDocumentData: !!downloadData.documentData,
            dataLength: downloadData.documentData ? downloadData.documentData.length : 0,
            dataType: typeof downloadData.documentData,
            isUint8Array: downloadData.documentData instanceof Uint8Array,
            filename: downloadData.filename,
            contentType: downloadData.contentType,
            message: downloadData.message
        });
        
        if (downloadData.documentData instanceof Uint8Array) {
            console.log('üîç CRITICAL DEBUG - Uint8Array first 10 bytes:', Array.from(downloadData.documentData.slice(0, 10)));
        } else if (typeof downloadData.documentData === 'string') {
            console.log('üîç CRITICAL DEBUG - String preview:', downloadData.documentData.substring(0, 50));
        } else {
            console.log('üö® CRITICAL DEBUG - Unexpected data type:', typeof downloadData.documentData, downloadData.documentData);
        }
        
        // Show session info and download options
        showSessionInfo(currentSession);
        showDownloadSection(downloadData);
        startCountdown(currentSession.expiresAt);
        
        // Hide form
        document.getElementById('access-request-form').style.display = 'none';
        
    } catch (error) {
        console.error('‚ùå Ephemeral access request failed:', error);
        showError(error.message);
        resetProgress();
    }
}

/**
 * Show progress container
 */
function showProgress() {
    document.getElementById('progress-container').style.display = 'block';
    document.getElementById('error-container').style.display = 'none';
}

/**
 * Set step as active
 */
function setStepActive(stepNumber) {
    const stepIcon = document.querySelector(`#step-${stepNumber} .step-icon`);
    stepIcon.className = 'step-icon active';
}

/**
 * Set step as completed
 */
function setStepCompleted(stepNumber) {
    const stepIcon = document.querySelector(`#step-${stepNumber} .step-icon`);
    stepIcon.className = 'step-icon completed';
    stepIcon.innerHTML = '‚úì';
}

/**
 * Set step as error
 */
function setStepError(stepNumber) {
    const stepIcon = document.querySelector(`#step-${stepNumber} .step-icon`);
    stepIcon.className = 'step-icon error';
    stepIcon.innerHTML = '‚úó';
}

/**
 * Update step details
 */
function updateStepDetails(stepNumber, details) {
    const stepDetails = document.querySelector(`#step-${stepNumber} .step-details`);
    stepDetails.textContent = details;
}

/**
 * Show session information
 */
function showSessionInfo(session) {
    document.getElementById('session-token').textContent = session.sessionToken;
    document.getElementById('ephemeral-did').textContent = session.ephemeralDID;
    document.getElementById('session-expiry').textContent = session.expiresAt.toLocaleString();
    document.getElementById('session-info').style.display = 'block';
}

/**
 * Show download section
 */
function showDownloadSection(decryptedData) {
    // Store decrypted data for download
    window.decryptedDocumentData = decryptedData;
    document.getElementById('download-section').style.display = 'block';
}

/**
 * Start countdown timer
 */
function startCountdown(expiresAt) {
    const timerElement = document.getElementById('countdown-timer');
    
    // SAFETY CHECK: Don't start countdown if session is already expired
    const now = new Date();
    const initialTimeLeft = expiresAt - now;
    
    console.log('üïí Starting countdown - initial check:', {
        expiresAt: expiresAt,
        now: now,
        timeLeft: initialTimeLeft,
        timeLeftMinutes: Math.floor(initialTimeLeft / 60000)
    });
    
    if (initialTimeLeft <= 0) {
        console.log('‚ö†Ô∏è Session already expired, not starting countdown');
        // Instead of expiring immediately, extend the session for demo purposes
        console.log('üîß Demo mode: Extending session by 1 hour for testing');
        const extendedExpiry = new Date(Date.now() + 60 * 60 * 1000); // 1 hour from now
        currentSession.expiresAt = extendedExpiry;
        expiresAt = extendedExpiry;
    }
    
    countdownInterval = setInterval(() => {
        const now = new Date();
        const timeLeft = expiresAt - now;
        
        if (timeLeft <= 0) {
            // Session expired
            console.log('‚è∞ Session expired via countdown');
            clearInterval(countdownInterval);
            handleSessionExpiry();
            return;
        }
        
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Update timer styling based on time left
        if (timeLeft < 5 * 60 * 1000) { // Less than 5 minutes
            timerElement.className = 'countdown-timer critical';
        } else if (timeLeft < 10 * 60 * 1000) { // Less than 10 minutes
            timerElement.className = 'countdown-timer warning';
        }
        
    }, 1000);
}

/**
 * Handle session expiry
 */
function handleSessionExpiry() {
    console.log('‚è∞ Session expired, cleaning up...');
    
    if (currentSession && currentSession.keyId) {
        // Destroy ephemeral key
        window.ephemeralDIDManager.destroyEphemeralKey(currentSession.keyId);
    }
    
    // Clear sensitive data
    if (window.decryptedDocumentData) {
        delete window.decryptedDocumentData;
    }
    
    // Show cleanup confirmation
    document.getElementById('session-info').style.display = 'none';
    document.getElementById('download-section').style.display = 'none';
    document.getElementById('cleanup-confirmation').style.display = 'block';
    
    // Reset session
    currentSession = null;
}

/**
 * Download document
 */
function downloadDocument() {
    alert('üöÄ DOWNLOAD FUNCTION CALLED - Data exists: ' + !!window.decryptedDocumentData);
    
    if (!window.decryptedDocumentData) {
        alert('‚ùå No decrypted document data available');
        showError('Document data not available');
        return;
    }
    
    try {
        const dataType = typeof window.decryptedDocumentData.documentData;
        const isUint8Array = window.decryptedDocumentData.documentData instanceof Uint8Array;
        const dataLength = window.decryptedDocumentData.documentData ? window.decryptedDocumentData.documentData.length : 0;
        
        alert('üìä DATA DEBUG: Type=' + dataType + ', IsUint8Array=' + isUint8Array + ', Length=' + dataLength);
        
        if (window.decryptedDocumentData.documentData instanceof Uint8Array) {
            const first4Bytes = Array.from(window.decryptedDocumentData.documentData.slice(0, 4));
            const isPDF = first4Bytes[0] === 37 && first4Bytes[1] === 80 && first4Bytes[2] === 68 && first4Bytes[3] === 70;
            alert('üîç UINT8ARRAY: First4Bytes=' + first4Bytes + ', IsPDF=' + isPDF);
        } else if (typeof window.decryptedDocumentData.documentData === 'string') {
            const preview = window.decryptedDocumentData.documentData.substring(0, 20);
            const isPDF = window.decryptedDocumentData.documentData.startsWith('%PDF');
            alert('üîç STRING: Preview=' + preview + ', IsPDF=' + isPDF);
        }
        
        // Create blob and download
        const blob = new Blob([window.decryptedDocumentData.documentData], { 
            type: window.decryptedDocumentData.contentType || 'application/pdf' 
        });
        
        alert('üîç BLOB CREATED: Size=' + blob.size + ', Type=' + blob.type);
        
        const url = URL.createObjectURL(blob);
        alert('üîç BLOB URL: ' + url);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = documentData.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        console.log('‚úÖ Document download initiated');
        
        // Don't revoke URL immediately - let user download first
        setTimeout(() => {
            URL.revokeObjectURL(url);
            console.log('üßπ Blob URL revoked after delay');
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Download failed:', error);
        showError('Failed to download document: ' + error.message);
    }
}

/**
 * View document in browser
 */
function viewDocument() {
    console.log('üëÅÔ∏è VIEW FUNCTION CALLED');
    console.log('üîç window.decryptedDocumentData exists?', !!window.decryptedDocumentData);
    
    if (!window.decryptedDocumentData) {
        console.log('‚ùå No decrypted document data available');
        showError('Document data not available');
        return;
    }
    
    try {
        console.log('üîç VIEW DEBUG - Full window.decryptedDocumentData:', window.decryptedDocumentData);
        console.log('üîç VIEW DEBUG - documentData type:', typeof window.decryptedDocumentData.documentData);
        console.log('üîç VIEW DEBUG - documentData instanceof Uint8Array:', window.decryptedDocumentData.documentData instanceof Uint8Array);
        console.log('üîç VIEW DEBUG - documentData length:', window.decryptedDocumentData.documentData ? window.decryptedDocumentData.documentData.length : 'undefined');
        
        if (window.decryptedDocumentData.documentData instanceof Uint8Array) {
            console.log('üîç VIEW DEBUG - First 20 bytes:', Array.from(window.decryptedDocumentData.documentData.slice(0, 20)));
            const isPDF = window.decryptedDocumentData.documentData[0] === 37 && window.decryptedDocumentData.documentData[1] === 80 && window.decryptedDocumentData.documentData[2] === 68 && window.decryptedDocumentData.documentData[3] === 70;
            console.log('üîç VIEW DEBUG - Is PDF?', isPDF);
            
            if (isPDF) {
                console.log('‚úÖ VIEW DEBUG - Confirmed PDF header detected');
            } else {
                console.log('‚ö†Ô∏è VIEW DEBUG - PDF header not found, bytes are:', [
                    window.decryptedDocumentData.documentData[0],
                    window.decryptedDocumentData.documentData[1], 
                    window.decryptedDocumentData.documentData[2],
                    window.decryptedDocumentData.documentData[3]
                ]);
            }
        } else if (typeof window.decryptedDocumentData.documentData === 'string') {
            console.log('üîç VIEW DEBUG - String preview:', window.decryptedDocumentData.documentData.substring(0, 50));
            console.log('üîç VIEW DEBUG - Is PDF string?', window.decryptedDocumentData.documentData.startsWith('%PDF'));
        }
        
        const blob = new Blob([window.decryptedDocumentData.documentData], { 
            type: window.decryptedDocumentData.contentType || 'application/pdf' 
        });
        
        console.log('üîç VIEW DEBUG - Created blob:', {
            size: blob.size,
            type: blob.type
        });
        
        const url = URL.createObjectURL(blob);
        console.log('üîç VIEW DEBUG - Created blob URL:', url);
        
        // Test the blob by reading it back
        const reader = new FileReader();
        reader.onload = function(e) {
            const result = new Uint8Array(e.target.result);
            console.log('üîç VIEW DEBUG - Blob verification - First 20 bytes:', Array.from(result.slice(0, 20)));
            console.log('üîç VIEW DEBUG - Blob verification - Is PDF?', result[0] === 37 && result[1] === 80 && result[2] === 68 && result[3] === 70);
        };
        reader.readAsArrayBuffer(blob);
        
        // Open in new window
        const newWindow = window.open(url, '_blank');
        
        if (newWindow) {
            console.log('‚úÖ Document opened in new tab');
            
            // Add error handling to the new window
            newWindow.addEventListener('load', function() {
                console.log('‚úÖ New window loaded successfully');
            });
            
            newWindow.addEventListener('error', function(error) {
                console.error('‚ùå New window error:', error);
            });
        } else {
            console.error('‚ùå Failed to open new window - popup blocked?');
            showError('Failed to open document - popup may be blocked');
        }
        
    } catch (error) {
        console.error('‚ùå View failed:', error);
        showError('Failed to view document: ' + error.message);
    }
}

/**
 * Show error message
 */
function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-container').style.display = 'block';
}

/**
 * Hide error message
 */
function hideError() {
    document.getElementById('error-container').style.display = 'none';
}

/**
 * Reset progress
 */
function resetProgress() {
    // Reset all steps to pending
    for (let i = 1; i <= 5; i++) {
        const stepIcon = document.querySelector(`#step-${i} .step-icon`);
        stepIcon.className = 'step-icon pending';
        stepIcon.innerHTML = i.toString();
    }
}

/**
 * Retry operation
 */
function retryOperation() {
    hideError();
    resetProgress();
    document.getElementById('progress-container').style.display = 'none';
    document.getElementById('access-request-form').style.display = 'block';
}

/**
 * Start new session
 */
function startNewSession() {
    // Reset UI
    document.getElementById('cleanup-confirmation').style.display = 'none';
    document.getElementById('access-request-form').style.display = 'block';
    document.getElementById('progress-container').style.display = 'none';
    
    // Clear form
    document.getElementById('business-justification').value = '';
    document.getElementById('security-acknowledgment').checked = false;
    
    resetProgress();
    hideError();
}

// Handle page unload - cleanup keys using new client
window.addEventListener('beforeunload', function() {
    if (currentSession && currentSession.sessionToken && window.ephemeralDIDClient) {
        window.ephemeralDIDClient.cleanupEphemeralSession(currentSession.sessionToken, false);
    }
});

// Auto-cleanup on page focus change using new client
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden' && currentSession && currentSession.sessionToken) {
        // Optionally cleanup when user switches tabs (aggressive security)
        setTimeout(() => {
            if (document.visibilityState === 'hidden') {
                console.log('üîí Auto-cleanup due to page being hidden for extended time');
                if (window.ephemeralDIDClient) {
                    window.ephemeralDIDClient.cleanupEphemeralSession(currentSession.sessionToken, false);
                }
                handleSessionExpiry();
            }
        }, 5 * 60 * 1000); // 5 minutes
    }
});
</script>
{% endblock %}